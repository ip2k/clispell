#!/usr/bin/env ruby
require 'raspell'
require 'mattscilipoti-rdialog'
require 'oald_parser'

# helper method for instantiating our ASpell API...
# using this, you only have to configure it in one spot.
def new_speller()
    # instantiate our speller and set the dict to en_US (English - United States) and ignore cAsE.
    speller = Aspell.new("en_US")
    speller.set_option("ignore-case", "true")
    return speller
end

# helper method for instantiating our dialog API...
# using this, you only have to configure it in one spot.
def new_dialog()
    # instantiate our dialog and set some options
    dialog = RDialog.new
    dialog.nocancel = true
    dialog.shadow = false
    return dialog
end

# look up a word in the Oxford Advanced Learners Dictionary
def define_word(someword)
    facade = OaldParser::Facade.create_configured_instance
    return facade.describe(str: someword)
end

# our method to see if a word is spelled correctly
def check_spelling(someword)
    myspeller = new_speller()
    # test [someword] for spelling error and return true if it's correct.
    if myspeller.check(someword)
        return true
    else
        return false
    end
end

def get_suggestions(someword)
    myspeller = new_speller()
    return myspeller.suggest(someword)
end

def show_suggestion_array(orig_word,suggestions)
    # use our new_dialog helper method and call the menu() method on it...
    # ...with our fancy text and suggestions array, then...
    # ...block until the user picks something and return what they picked.
    return new_dialog.menu("#{orig_word} not found or spelled incorrectly.  Select a word below view the definition.", suggestions)
end

def show_definition(definition)
    return new_dialog.msgbox(definition)
end

# if the user didn't pass any args, abort and let them know that they need to.
if ARGV.first.nil?
    abort("You must specify a word that you want to spell check or define")
else
    # if the user spelled the word right, just show the definition...
    # and tell them they were right while we're waiting on the API.
    if check_spelling(ARGV.first)
        puts "#{ARGV.first} is spelled correctly, waiting for the definition (requires internet access)..."
        definition = define_word(ARGV.first)
        show_definition("#{ARGV.first}:\n#{definition}")
        exit(0)
    else
        # get possible words if the user sends us a typo'd word.
        suggestions_array = get_suggestions(ARGV.first)

        # convert suggestions into an array of single-item arrays...
        # so that dialog doesn't think we want to display each chr.
        suggestions_array.map! { |s| [s] }

        # call our show_suggestion_array method with the array-of-arrays.
        user_selection_string = show_suggestion_array(ARGV.first, suggestions_array)
        definition = define_word(user_selection_string)
        show_definition("#{user_selection_string}:\n#{definition}")
        exit(0)
    end
end
